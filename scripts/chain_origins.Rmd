---
title: "Fig. 2"
output: pdf_document
---

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
knitr::opts_chunk$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
```

```{r, include=FALSE}
source("../grapevine/database/R/utility.R")
source("../grapevine/utility_functions.R")
source("../grapevine/generate_figures/functions.R")
source("scripts/figures_shared_vars.R")
require(dplyr)
require(ggplot2)
db_connection = open_database_connection(
  config_file = "../grapevine/workdir/input/config.yml")
```

Load data

```{r}
workdir <- "results_main"

grapevine_results <- load_grapevine_results(
  workdir = workdir, 
  min_chain_size = 1,
  viollier_only = F)
chains <- grapevine_results$chains
origins <- grapevine_results$origins

# Count each origin once per unique foreign MRCA
origins_data <- get_origin_prior_vs_posterior_data(
  workdir = workdir,
  origins_representative = origins) %>%
  mutate(iso_code = recode(iso_code, "XKX" = "KOS"))

# Count each origin once per unique chain
origins_per_chain <- merge(
  x = origins,
  y = chains,
  by = c("tree",  "chains_assumption", "foreign_mrca", "foreign_tmrca", "foreign_tmrca_CI"),
  all = T)
origins_data_per_chain <- get_origin_prior_vs_posterior_data(
  workdir = workdir,
  origins_representative = origins_per_chain) %>%
  mutate(iso_code = recode(iso_code, "XKX" = "KOS"))

# Count each origin once per unique chain, use the swiss mrca data and not the foreign mrca date
origins_data_per_chain_ch_mrca <- get_origin_prior_vs_posterior_data(
  workdir = workdir,
  origins_representative = origins_per_chain,
  posterior_date = "ch_tmrca") %>%
  mutate(iso_code = recode(iso_code, "XKX" = "KOS"))
```

Summarize different data options

```{r}
origins_tmp <- origins %>% 
  group_by(chains_assumption, tree, foreign_mrca) %>%
  summarize(n_times_counted = n())
origins_per_chain_tmp <- origins_per_chain  %>% 
  group_by(chains_assumption, tree, foreign_mrca) %>%
  summarize(n_times_counted = n())

ggplot(
  data = origins_tmp,
  aes(x = n_times_counted)) + 
  geom_histogram() + 
  facet_grid(. ~ chains_assumption) + 
  ggtitle("Counting each unique foreign mrca once counts foreign mrcas this many times")
ggplot(
  data = origins_per_chain_tmp,
  aes(x = n_times_counted)) + 
  geom_histogram() + 
  facet_grid(. ~ chains_assumption, scales= "free_x") + 
  ggtitle("Counting each chain once counts each foreign mrca up to this many times")
```

Get origins that acheive n% frequency in any month in either the prior, posterior (max), or posterior (min)

```{r}
most_common_origins <- get_most_common_origins_to_plot(
  origins_data = origins_data)
most_common_origins_per_chain <- get_most_common_origins_to_plot(
  origins_data = origins_data_per_chain)
```

Make plot
- posterior doesn't change so much for smallest plausible (max) chains because most chains descending from polytomies aren't included anyways (foreign_mrca is same as ch_mrca)

```{r}
country_colors <- get_country_colors(db_connection)
origins_plot <- make_origins_plot(
  country_colors = country_colors, 
  origins_data = origins_data, 
  most_common_origins = most_common_origins)
origins_per_chain_plot <- make_origins_plot(
  country_colors = country_colors, 
  origins_data = origins_data_per_chain, 
  most_common_origins = most_common_origins_per_chain)
origins_per_chain_ch_tmrca_plot <- make_origins_plot(
  country_colors = country_colors, 
  origins_data = origins_data_per_chain_ch_mrca, 
  most_common_origins = most_common_origins_per_chain)

show(origins_plot)
show(origins_per_chain_plot)
show(origins_per_chain_ch_tmrca_plot)
```

Save plots

```{r}
save_origins_plot(
  plot = origins_plot,
  plotname = "fig_SX_chain_origins_per_foreign_mrca_foreign_tmrca.png")
save_origins_plot(
  plot = origins_per_chain_plot,
  plotname = "fig_SX_chain_origins_per_chain_foreign_tmrca.png")
save_origins_plot(
  plot = origins_per_chain_ch_tmrca_plot,
  plotname = "fig_2_chain_origins_per_chain_ch_tmrca.png")
```

Table area in prior vs. posterior 

```{r}
make_tables <- function(
  origins_data, wave_breaks, most_common_origins
) {
  complete_period_breaks <- c(
    range(as.Date(origins_data$date)), 
    wave_breaks)  # most extreme dates + specified intermediate breakpoints
  
  origins_data_to_table <- origins_data %>%
    mutate(
      period = cut.Date(
        x = as.Date(date), 
        breaks = as.Date(complete_period_breaks),
        include.lowest = T),
      origin_to_plot = case_when(
        iso_code %in% most_common_origins$iso_code ~ iso_code_to_country_name(iso_code),
        T ~ "other"))
  
  origins_data_to_table <- rbind(
    origins_data_to_table %>% 
      mutate(chains_assumption = case_when(
        est_type == "prior" ~ "max",
        T ~ chains_assumption
      )),
    origins_data_to_table %>% 
      filter(est_type == "prior") %>%
      mutate(chains_assumption = "min")
  )
  
  origins_table_posterior_v_prior <- origins_data_to_table %>%
    group_by(period, est_type, chains_assumption) %>%
    mutate(total_n_inds = sum(n_inds)) %>%
    group_by(period, origin_to_plot, est_type, chains_assumption) %>%
    summarize(frac_inds = sum(n_inds) / total_n_inds[1]) %>%
    tidyr::pivot_wider(
      names_from = est_type,
      values_from = frac_inds) %>%
    mutate(
      posterior_to_prior = signif(posterior / prior, digits = 2),
      # posterior_to_prior = recode(
      #   .x = as.character(posterior_to_prior),
      #   "Inf" = "0 in prior",  # Inf means x/0 (x posterior, 0 prior)
      #   "NaN" = "0 in prior and posterior"),  # NaN means 0/0 (0 posterior, 0 prior)
      posterior_to_prior = paste(posterior_to_prior, " (", signif(posterior, digits = 2), "/", signif(prior, digits = 2), ")", sep = "")) %>%
    select(-c(posterior, prior)) %>%
    tidyr::pivot_wider(
      names_from = c(chains_assumption, period), 
      values_from = posterior_to_prior)
  
  origins_table_posterior_v_exposures <- origins_data_to_table %>%
    filter(n_inds_type != "commuter_permits", n_inds_type != "tourist_arrivals") %>%
    group_by(period, est_type, chains_assumption) %>%
    mutate(total_n_inds = sum(n_inds)) %>%
    group_by(period, origin_to_plot, est_type, chains_assumption) %>%
    summarize(frac_inds = sum(n_inds) / total_n_inds[1]) %>%
    tidyr::pivot_wider(
      names_from = est_type,
      values_from = frac_inds) %>%
    mutate(
      posterior_to_prior = signif(posterior / prior, digits = 2),
      # posterior_to_prior = recode(
      #   .x = as.character(posterior_to_prior),
      #   "Inf" = "0 in prior",  # Inf means x/0 (x posterior, 0 prior)
      #   "NaN" = "0 in prior and posterior"),  # NaN means 0/0 (0 posterior, 0 prior)
      posterior_to_prior = paste(posterior_to_prior, " (", signif(posterior, digits = 2), "/", signif(prior, digits = 2), ")", sep = "")) %>%
    select(-c(posterior, prior)) %>%
     tidyr::pivot_wider(
      names_from = c(chains_assumption, period), 
      values_from = posterior_to_prior)

  return(list(
    "origins_table_posterior_v_prior" = origins_table_posterior_v_prior,
    "origins_table_posterior_v_exposures" = origins_table_posterior_v_exposures))
}

origins_tables <- make_tables(
  origins_data = origins_data,
  wave_breaks = wave_breaks, 
  most_common_origins = most_common_origins)

origins_tables_per_chain <- make_tables(
  origins_data = origins_data_per_chain,
  wave_breaks = wave_breaks, 
  most_common_origins = most_common_origins_per_chain)

origins_tables_per_chain_ch_mrca <- make_tables(
  origins_data = origins_data_per_chain_ch_mrca,
  wave_breaks = wave_breaks, 
  most_common_origins = most_common_origins_per_chain)

View(origins_tables_per_chain_ch_mrca$origins_table_posterior_v_prior)
View(origins_tables_per_chain_ch_mrca$origins_table_posterior_v_exposures)
```

Save tables

```{r}
save_table_tex <- function(tables, table_prefix) {
  print(
    xtable::xtable(
      x = tables$origins_table_posterior_v_prior  %>%
        filter(origin_to_plot != "other") %>%
        rename("Origin country" = "origin_to_plot"), 
      type = "latex"), 
    include.rownames = F,
    file = paste("tables/", table_prefix, "_posterior_v_prior.tex", sep = ""))
  
  print(
    xtable::xtable(
      x = tables$origins_table_posterior_v_exposures %>%
        filter(origin_to_plot != "other") %>%
        rename("Origin country" = "origin_to_plot"), 
      type = "latex"), 
    include.rownames = F,
    file = paste("tables/", table_prefix, "_posterior_v_exposures.tex", sep = ""))
}
save_table_tex(
  tables = origins_tables,
  table_prefix = "table_SX_chain_origins_per_foreign_mrca_foreign_tmrca")
save_table_tex(
  tables = origins_tables_per_chain,
  table_prefix = "table_SX_chain_origins_per_chain_foreign_tmrca")
save_table_tex(
  tables = origins_tables_per_chain_ch_mrca,
  table_prefix = "table_1_chain_origins_per_chain_ch_tmrca")
```



