---
title: "Plot introductions vs. European incidence"
author: nadeaus
date: 12.10.21
output: html_notebook
---

This script is to see if the relationship between Europe-wide incidence and estimated imports into Switzerland changes upon the Swiss border closures.

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
knitr::opts_chunk$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
```

```{r, include=FALSE}
require(dplyr)
require(tidyr)
require(ggplot2)
require(cowplot)
library(lubridate)
source("../sars_cov_2/grapevine/database/R/utility.R")
source("../sars_cov_2/grapevine/utility_functions.R")
source("../sars_cov_2/grapevine/generate_figures/functions.R")
source("scripts/figures_shared_vars.R")
```

Load grapevine data

```{r}
workdir <- "results_main"
outdir <- paste(workdir, "output", sep = "/")
outdir <- "figures"
grapevine_results <- load_grapevine_results(
  workdir = workdir,
  min_chain_size = 1,
  viollier_only = F)
```

Load case data for European countries

```{r}
CASE_COUNT_LINK <- "https://covid.ourworldindata.org/data/owid-covid-data.csv"  # early data for France not very good
CASE_COUNT_LINK <- "https://opendata.ecdc.europa.eu/covid19/casedistribution/csv/"
cases_raw <- read.csv(url(CASE_COUNT_LINK), na.strings = "", fileEncoding = "UTF-8-BOM") %>%
  filter(continentExp == "Europe") %>%
  select(countryterritoryCode, dateRep, cases) %>%
  mutate(date = as.Date(dateRep, "%d/%m/%Y")) %>%
  filter(date <= as.Date("2020-12-01"))

cases_summary <- cases_raw %>%
        mutate(country = case_when(
                countryterritoryCode == "CHE" ~ "Switzerland",
                countryterritoryCode == "FRA" ~ "France",
                countryterritoryCode == "DEU" ~ "Germany",
                countryterritoryCode == "ITA" ~ "Italy",
                T ~ "Other European")) %>%
        group_by(date, country) %>%
        summarize(cases = sum(cases), .groups = "drop") %>%
        group_by(country) %>%
        arrange(date) %>%
        mutate(weekly_avg_new_cases = zoo::rollmean(cases,7, align = "center", na.pad = T))
```

Summarize introductions, their persistence and merge with case data

```{r}
chain_summary_stats <- grapevine_results$samples %>%
  group_by(tree, chains_assumption, chain_idx) %>%
  summarize(first_sample_date = min(date),
            last_sample_date = max(date),
            .groups = "drop") %>%
  mutate(time_to_last_sample = difftime(last_sample_date, first_sample_date, units = "days")) %>%
  full_join(y = grapevine_results$chains, by = c("tree", "chains_assumption", "chain_idx"))

#' Returns the date of the Sunday of the week.
#' Inspired by: https://stackoverflow.com/questions/32434549/how-to-find-next-particular-day
get_start_of_week <- function(date) {
  .day <- wday(date, label = TRUE)
  sunday <- date + days(1 - as.numeric(.day))
  return(sunday)
}

introduction_summary <- chain_summary_stats %>%  # weekly summary
  mutate(date = get_start_of_week(first_sample_date)) %>%
  group_by(date, chains_assumption, .groups = "drop") %>%
  summarise(
    introductions_by_first_sample_date = n(),
    frac_60_day_persisters = sum(time_to_last_sample >= 60) / n()) %>%
  mutate(country = "Switzerland")

# exclude undefined values for persistence
max_date <- max(introduction_summary$date) - 60
introduction_summary[introduction_summary$date > max_date, "frac_60_day_persisters"] <- NA

# introduction_summary <- chain_summary_stats %>%  # monthly summary
#   mutate(date = as.Date(format(first_sample_date, "%Y-%m-01"))) %>%
#   group_by(date, chains_assumption) %>%
#   summarise(
#     introductions_by_first_sample_date = n(),
#     frac_60_day_persisters = sum(time_to_last_sample >= 60) / n()) %>%
#   mutate(country = "Switzerland")

introduction_summary_wide <- introduction_summary %>%
        pivot_wider(names_from = "chains_assumption", values_from = c(
                "introductions_by_first_sample_date",
                "frac_60_day_persisters"))

combined_data <- cases_summary %>% full_join(introduction_summary_wide, by = c("date", "country"))
```

Plot case data vs. introductions

```{r}

country_color_scale <- scale_color_manual(
  values = c("Switzerland" = "#E69F00", "France" = "#56B4E9", "Germany" = "#F0E442", "Italy" = "#009E73", "Other European" = "#CC79A7"),
  name = element_blank())

incidence_plot <- ggplot(data = combined_data %>%
        filter(date <= as.Date("2020-04-15"), date >= as.Date("2020-02-15")),
        aes(x = date, color = country)) +
        geom_line(aes(y = weekly_avg_new_cases)) +
        # geom_col(aes(y = weekly_avg_new_cases), position = "dodge") +
        # geom_label(data = . %>% group_by(metric) %>% filter(value == max(value, na.rm = T)), aes(label = date)) +  # label maximum point
        scale_x_date(date_breaks = "1 month", date_labels = "%b.") +
        labs(y = "Confirmed cases\n(weekly average)", x = "") +
        shared_theme +
        country_color_scale

introductions_plot <- ggplot(data = combined_data %>%
        filter(country == "Switzerland", date <= as.Date("2020-04-15"), date >= as.Date("2020-02-15")),
        aes(x = date)) +
        geom_errorbar(aes(ymin = introductions_by_first_sample_date_min, ymax = introductions_by_first_sample_date_max)) +
        scale_x_date(date_breaks = "1 month", date_labels = "%b.") +
        labs(y = "New introductions\n (by week)", x = "") +
        shared_theme +
        geom_vline(xintercept = as.Date("2020-03-13"), linetype = "dashed")

# Extract legend to plot seperately
incidence_legend <- get_legend(
  # create some space to the left of the legend
  incidence_plot +
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom") +
    guides(fill=guide_legend(nrow=2,byrow=TRUE)))
incidence_plot <- incidence_plot + theme(legend.position = "none")
incidence_plot_v2 <- incidence_plot +
  geom_vline(xintercept = as.Date("2020-03-13"), linetype = "dashed")

main_plots <- align_plots(introductions_plot, incidence_plot_v2, align = "vh",  axis = 'bt')
left_plots <- plot_grid(
  main_plots[[1]], main_plots[[2]],
  ncol = 1)

plot_grid(left_plots, incidence_legend, rel_heights = c(1, 0.2), ncol = 1)
ggsave("figures/introductions_vs_european_indicence.png",
       width = single_col_width, height = single_col_width, units = "cm")
```

Plot introductions vs. persistence, comparison to incidence

```{r}
# Manipulate data: sometimes max chains has more persisters in a week, sometimes min chains assumption
introduction_summary_v2 <- rbind(
  introduction_summary %>%
    group_by(date) %>%
    arrange(frac_60_day_persisters, chains_assumption) %>%
    mutate(which_most = chains_assumption[[1]],
           min = frac_60_day_persisters[1],
           max = frac_60_day_persisters[2],
           metric = "Fraction of new introductions that persist 60 days"),
  introduction_summary %>%
    group_by(date) %>%
    arrange(-introductions_by_first_sample_date) %>%
    mutate(which_most = chains_assumption[[1]],
           max = introductions_by_first_sample_date[1],
           min = introductions_by_first_sample_date[2],
           metric = "Number of new introductions")) %>%
  mutate(metric = factor(x = metric, levels = c("Number of new introductions", "Fraction of new introductions that persist 60 days")))

highlight_data <- data.frame(
  date_start = as.Date(c("2020-03-13", "2020-03-17")),
  date_end = as.Date(c("2020-06-15", "2020-04-27")),
  metric = c("Number of new introductions", "Fraction of new introductions that persist 60 days"),
  event = c("Borders closed", "Partial lockdown")) %>%
  mutate(metric = factor(x = metric, levels = c("Number of new introductions", "Fraction of new introductions that persist 60 days")))

fill_scale <- scale_fill_manual(values = c(
  "Borders closed" = "black",
  "Partial lockdown" = "grey"))

p1 <- ggplot(
  data = introduction_summary_v2,
  aes(x = date)) +
  geom_errorbar(aes(ymin = min, ymax = max)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b.", limits = as.Date(c("2020-02-01", "2020-12-03"))) +
  ylim(0, NA) +
  facet_wrap(metric ~ ., ncol = 1, scales = "free_y", ) +
  labs(y = "Value (by week)", x = element_blank()) +
  shared_theme +
  fill_scale +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  geom_rect(data = highlight_data, aes(xmin = date_start, xmax = date_end, ymin = -Inf, ymax = Inf, fill = event), alpha = 0.3)

p1

p2 <- incidence_plot_v2 +  # use incidence_plot for no dashed line and area instead
  # annotate("rect",
  #          xmin = as.Date("2020-03-13"),
  #          xmax = as.Date("2020-06-15"),
  #          ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "grey") +
  guides(color = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(nrow=3,byrow=TRUE))

main_plots <- align_plots(p1, p2, align = "v",  axis = 't')

plot_grid(main_plots[[1]], main_plots[[2]], ncol = 2, labels = "AUTO", rel_widths = c(1, 0.7))

ggsave("figures/introductions_and_persistence.png",
       width = double_col_width, height = single_col_width, units = "cm")
```
