---
title: "Test for travel quarantine effect on SARS-CoV-2 imports"
output: pdf_document
---

This script is to test whether the rate of new introductions from a country
is effected by whether travellers from the country are under quarantine orders.

Date range for analysis is constrained to quarantine list data start/end dates.
Phylogenetic import estimates are only for chains where travel context sequences
clustered with them, and also only for one chain per polytomy. So these represent 
estimates for only a fraction of the total number of chains.

Q: why does it matters which transmission chain assumption we make if we take each polytomy as 1 import anyways?
A: when polytomies are allowed to be Swiss, if the polytomy node is swiss then indeed, we cannot classify a location for the origin of the transmission chain
This means should have more datapoints when s=F.

TODO: compare/contrast results when s=T and s=F

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
knitr::opts_chunk$set(root.dir = "/Users/nadeaus/Repos/cov-swiss-phylogenetics")
```

```{r}
source("../grapevine/database/R/utility.R")
source("../grapevine/utility_functions.R")
source("../grapevine/generate_figures/functions.R")
source("scripts/figures_shared_vars.R")
require(dplyr)
require(ggplot2)
db_connection = open_database_connection(config_file = "../grapevine/workdir/input/config.yml")
```

Load data

```{r}
workdir <- "results_main"
```

Load data: independent variables

```{r}
# indep variables: source country, whether travellers under quarantine order by day
travel_quarantine_by_country_day <- get_travel_quarantine_by_country_day(
  db_connection = db_connection
) %>% rename(iso_country = iso_code)
# indep variable: source country incidence per capita per day
country_incidence <- get_country_incidence(
  min_date = min(travel_quarantine_by_country_day$date), 
  max_date = max(travel_quarantine_by_country_day$date),
  db_connection = db_connection
)  
# indep variable: distance from country to Switzerland
country_distances <- get_country_distances(
  non_focal_countries = as.character(unique(travel_quarantine_by_country_day$iso_country)),
  focal_countries = "CHE",
  db_connection = db_connection
) %>% rename(iso_country = iso_code)
# indep variable: travel connection to Switzerland
# country_arrivals <- read.delim(
#   file = paste(
#     workdir, 
#     "tmp/alignments/estimated_monthly_infectious_arrivals.txt", 
#     sep = "/"),
#   stringsAsFactors = F) %>%
#   select(date, iso_code, n_tourist_arrivals, n_commuter_permits)

# clean data
warn_missing_incidence_data(
  travel_quarantine_by_country_day = travel_quarantine_by_country_day, 
  country_incidence = country_incidence
)
travel_quarantine_by_country_day <- travel_quarantine_by_country_day %>%
  filter(iso_country %in% country_incidence$iso_country)

# merge data
indep_vars <- merge(
    x = travel_quarantine_by_country_day, y = country_incidence,
    by = c("iso_country", "date"), 
    all = T) 
indep_vars <- merge(
  x = indep_vars, y = country_distances,
  by = "iso_country",
  all.x = T)
# indep_vars <- merge(
#   x = indep_vars, y = country_arrivals,
#   by = c("iso_code", "date"),
#   all.x = T)
```

Load data: possible dependent variables

```{r}
# dep variable: number of FOPH recorded exposures from each country each day
recorded_exposures <- get_exposures_per_country_day(
  min_date = min(travel_quarantine_by_country_day$date), 
  max_date = max(travel_quarantine_by_country_day$date),
  db_connection = db_connection
) %>% rename(iso_country = iso_country_exp)
# dep variable: number of lineages departing a country each day
grapevine_results <- load_grapevine_results(
  workdir = workdir, 
  min_chain_size = 1,
  viollier_only = F)
origins <- grapevine_results$origins
origins_long <- pivot_origins_longer(origins = origins)

origins_daily <- origins_long %>% 
  filter(foreign_tmrca >= min(travel_quarantine_by_country_day$date),
         foreign_tmrca <= max(travel_quarantine_by_country_day$date)) %>%
  group_by(foreign_tmrca, origin, chains_assumption) %>%
  summarize(n_lineages = sum(asr_contribution, na.rm = T)) %>%
  ungroup() %>%
  rename(iso_country = origin, date = foreign_tmrca)

# merge data
dep_vars <- merge(
  x = rbind(
    recorded_exposures %>% mutate(chains_assumption = "min"),
    recorded_exposures %>% mutate(chains_assumption = "max")), 
  y = origins_daily,
  by = c("iso_country", "date", "chains_assumption"),
  all = T)
```

Merge independent and dependent variables, aggregate timechunks

```{r}
model_data_daily <- merge(
  x = rbind(indep_vars %>% mutate(chains_assumption = "min"),
            indep_vars %>% mutate(chains_assumption = "max")), 
  y = dep_vars, 
  by = c("iso_country", "date", "chains_assumption"),
  all = T) %>%
  tidyr::replace_na(list(
    "quarantine_order" = F,  # not on the quarantine list = no quarantine order
    "n_exposures" = 0,  # no exposures in bag_meldeformular = 0 exposures
    "n_lineages" = 0,  # no foreign attachment points in the month have travel context descendents from the country = 0 lineages imported from the country
    "n_tourist_arrivals" = 0,
    "n_commuter_permits" = 0)) %>%  # no tourist arrivals to hotels recorded or commuter permits = 0 arrivals 
  filter(date >= "2019-12-01", date <= "2020-12-01") %>%
  group_by(iso_country) %>%
  mutate(
    quarantine_y_and_n = length(unique(quarantine_order)) == 2,
    month = format(date, "%Y-%m-01")) %>%
  filter(quarantine_y_and_n) %>%  # only countries on & off quarantine list at some point
  select(-quarantine_y_and_n) %>%
  ungroup()

model_data_weekly <- model_data_daily %>%
  mutate(date = format(date, "%y-%W-1")) %>%
  group_by(date, month, iso_country, chains_assumption) %>%
  summarize(
    n_exposures = sum(n_exposures),
    n_lineages = sum(n_lineages),
    dist_to_CHE = dist_to_CHE[1],
    new_cases_per_million = mean(new_cases_per_million),
    new_cases = sum(new_cases),
    quarantine_order = sum(quarantine_order) / n())  # indep var frac of days on list 

model_data_monthly <- model_data_daily %>%
  select(-c(date)) %>%
  rename(date = month) %>%
  group_by(date, iso_country, chains_assumption) %>%
  summarize(
    n_exposures = sum(n_exposures),
    n_lineages = sum(n_lineages),
    dist_to_CHE = dist_to_CHE[1],
    new_cases_per_million = mean(new_cases_per_million),
    new_cases = sum(new_cases),
    quarantine_order = sum(quarantine_order) / n()) # ,  # indep var frac of days on list 
    # n_tourist_arrivals = sum(n_tourist_arrivals, na.rm = T),  # a monthly variable only  
    # n_commuter_permits = sum(n_commuter_permits, na.rm = T))  # a monthly variable only  
```

Plot data summary

```{r}
model_data_to_plot <- model_data_weekly %>%
  mutate(
    quarantine_order = quarantine_order > 0.5) %>%
  tidyr::pivot_wider(
    names_from = chains_assumption,
    values_from = "n_lineages",
    names_prefix = "n_lineages_") %>%
  tidyr::pivot_longer(
    cols = c("n_exposures", "n_lineages_min", "n_lineages_max"),
    names_to = "facet",
    values_to = "n_inds") %>%
  group_by(iso_country) %>%
  mutate(has_some_imports = sum(n_inds) > 0) %>%
  ungroup() %>%
  filter(has_some_imports)

model_data_to_plot$facet <- factor(
  x = model_data_to_plot$facet,
  levels = c(
    "n_exposures",
    "n_lineages_min",
    "n_lineages_max"),
  labels = c(
    "Reported exposures",
    "Phylogenetic estimates\n (Largest plausible chains)",
    "Phylogenetic estimates\n (Smallest plausible chains)")
)

dep_var_by_quarantine_status <- ggplot(
  data = model_data_to_plot %>% 
    filter(
           facet != "Phylogenetic estimates\n (Largest plausible chains)"),
  mapping = aes(
    x = as.Date(date, format = "%y-%W-%u"),
    y = iso_country)) + 
  geom_point(
    aes(color = quarantine_order)) + 
  geom_point(
    aes(
      size = ifelse(n_inds == 0, NA, n_inds)),
    alpha = 0.5) +
  scale_color_manual(
    values = c(`FALSE` = "grey", `TRUE` = "red"),
    name = "Country under FOPH quarantine order") +
  scale_size_continuous(
    name = "Number of imports",
    range = c(0, 6)) + 
  theme_bw() + 
  labs(x = element_blank(), y = "Origin country") + 
  facet_grid(. ~ facet) + 
  theme(
    legend.position = "bottom", legend.box = "vertical", legend.margin = margin(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)) + 
  scale_x_date(date_labels = "%b. %Y", date_breaks = "1 month")

show(dep_var_by_quarantine_status) 

# ggsave(
#   x = dep_var_by_quarantine_status,
#   file = paste("figures", "chain_origins_by_quarantine_status.png", sep = "/"),
#   width =  double_col_width,
#   height = double_col_width * 0.75,
#   units = "cm")
```

Define model

```{r}
fit_model <- function(
  model_data, return_fitted_model = F, dep_varname, indep_varnames, s,
  interaction_varnames = c()
) {
  chains_assumption = ifelse(s, yes = "min", no = "max")
  my_formula <- paste(dep_varname, " ~ ", 
                      paste0(indep_varnames, collapse = " + "), sep = "")
  if (length(interaction_varnames) > 1) {
    my_formula <- paste(
      my_formula, 
      paste0(interaction_varnames, collapse = ":"), sep = " + ")
  }
  print(paste("Fitted model:", my_formula))
  print(paste("Dataset: chains_assumption = ", chains_assumption))
  fitted_model <- lm(
    data = model_data %>% filter(
      chains_assumption == !! chains_assumption),
    formula = as.formula(my_formula))
  print(summary(fitted_model))
  if (return_fitted_model) {
    return(fitted_model)
  }
}
```

Plot possible independent variables vs. dependent variable

```{r}
model_data_monthly_gathered <- model_data_monthly %>%
  tidyr::gather(
    key = "variable", value = "value",
    dist_to_CHE, new_cases_per_million, new_cases, quarantine_order, date)
ggplot(data = model_data_monthly_gathered,
       aes(x = value, y = n_lineages)) + 
  geom_point() + 
  facet_grid(chains_assumption ~ variable, scales = "free")
```

Fit model to lineage data
Assumption: travel is constant year-round

```{r}
fit_model(
  model_data = model_data_monthly,
  dep_varname = "n_lineages",
  indep_varnames = c(
    "new_cases_per_million", "dist_to_CHE", "quarantine_order"),
  s = T)
fit_model(
  model_data = model_data_monthly,
  dep_varname = "n_lineages",
  indep_varnames = c(
    "new_cases_per_million", "dist_to_CHE", "quarantine_order"),
  s = F)
```

Fit model to exposure data
Assumption: travel is constant year-round

```{r}
fit_model(
  model_data = model_data_monthly,
  dep_varname = "n_exposures",
  indep_varnames = c(
    "new_cases_per_million", "dist_to_CHE", "quarantine_order"),
  s = T)
fit_model(
  model_data = model_data_monthly,
  dep_varname = "n_exposures",
  indep_varnames = c(
    "new_cases_per_million", "dist_to_CHE", "quarantine_order"),
  s = F)
```

People still come into Switzerland from countries under quarantine list (exposure data).
Do these individuals contribute to onward transmission?
How many of the exposure cases are singletons vs. index cases in periods with/without quarantine?

## Load results into R
```{r}
source("../grapevine/generate_figures/functions.R")
source("../grapevine/generate_alignments/functions.R")
source("../grapevine/database/R/utility.R")
source("../grapevine/utility_functions.R")

workdir <- paste(
  "/Users/nadeaus/Repos/cov-swiss-phylogenetics/results_all/validation",
  "accuracy_validation",
  sep = "/")
grapevine_results <- load_grapevine_results(workdir = workdir)
bag_exposures <- get_bag_exposures(db_connection = db_connection)
metadata <- load_sample_metadata(workdir = workdir)

samples <- merge(
  x = bag_exposures,
  y = grapevine_results$samples,
  all.y = T,
  by = "gisaid_epi_isl") %>%
  mutate(
    iso_country_exposure = coalesce(
      x = iso_country_exposure.x,
      y = iso_country_exposure.y),
    has_foreign_exposure = case_when(
      iso_country_exposure != "CHE" ~ T,
      T ~ F)) 

samples_with_chain_mrca <- merge(
  x = samples,
  y = grapevine_results$chains %>%
    select(chains_assumption, tree, chain_idx, foreign_mrca, foreign_tmrca, size),
  by = c("chains_assumption", "tree", "chain_idx"),
  all.x = T)
```

# How many of the exposure cases are singletons vs. index cases in periods with/without quarantine?
```{r}
temp <- samples_with_chain_mrca %>%
  filter(iso_country_exposure != "CHE", sample_idx < 3) %>%
  mutate(is_singleton = size == 1) %>%
  left_join(travel_quarantine_by_country_day, by = c("date" = "date", "iso_country_exposure" = "iso_country")) %>%
  mutate(quarantine_order = replace_na(quarantine_order, replace = F))

# Quarantine not successful examples?
temp %>% 
  filter(chains_assumption == "max", !is_singleton, quarantine_order) %>%
  select(tree, chain_idx, iso_country_exposure, sample_idx, date, strain, originating_lab, size, foreign_tmrca)

# Quarantine successful examples?
temp %>% 
  filter(chains_assumption == "max", is_singleton, quarantine_order) %>%
  select(tree, chain_idx, iso_country_exposure, sample_idx, date, strain, originating_lab, size, foreign_tmrca)
```

