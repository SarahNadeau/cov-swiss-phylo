---
title: "Validate CHE results"
output: html_notebook
---

This script is to see whether identified Swiss introductions are geographically structured as a proxy validation criteria.


```{r, include=FALSE}
require(dplyr)
require(tidyr)
require(ggplot2)
source("../sars_cov_2/grapevine/utility_functions.R")
source("../sars_cov_2/grapevine/generate_figures/functions.R")
source("scripts/figures_shared_vars.R")
```

Load grapevine data

```{r}
workdir <- "results_all/2021-08-10_for_manuscript_rep_1"
outdir <- paste(workdir, "output", sep = "/")
grapevine_results <- load_grapevine_results(
  workdir = workdir,
  min_chain_size = 1,
  viollier_only = F)
```

Plot distribution of number of regions in each introduction (expect to be right-skewed)
```{r}
divisions_per_introduction <- grapevine_results$samples %>%
        group_by(chains_assumption, tree, chain_idx) %>%
        summarise(
          n_divisions = length(unique(division)),
          size = n(),
          .groups = "drop")

divisions_per_introduction_plot <- ggplot(
  data = divisions_per_introduction %>% filter(size > 1),
  aes(x = n_divisions)
) +
  geom_bar() +
  facet_grid(. ~ chains_assumption, labeller = labeller(chains_assumption = chain_assumption_labs)) +
  labs(y = "Number of introductions\n(excluding singletons)", x = "Number of Swiss cantons") +
  shared_theme

# Quantify number of chains in fewer than 3 cantons
divisions_per_introduction %>%
        group_by(chains_assumption) %>%
        summarize(frac_in_more_than_2_divisions = sum(n_divisions > 2) / n())
```

See if as expected larger introductions found in more regions
```{r}
divisions_by_introduction_size <- divisions_per_introduction %>%
  mutate(size_bin = case_when(
    size == 1 ~ 1,
    size < 4 ~ 2,
    size < 11 ~ 3,
    size < 100 ~ 4,
    T ~ 5
  )) %>%
  group_by(chains_assumption, size_bin) %>%
  summarise(n_div_mean = mean(n_divisions), n_div_sd = sd(n_divisions), n = n()) %>%
  mutate(size_bin = factor(
    size_bin, 
    levels = c(1, 2, 3, 4, 5), 
    labels = c("1", "2 - 3", "4 - 10", "10 - 100", ">100")
  ))

divisions_by_introduction_size_plot <- ggplot(
  data = divisions_by_introduction_size,
  aes(x = size_bin, y = n_div_mean)
) +
  geom_point() +
  geom_errorbar(aes(ymin = n_div_mean - n_div_sd, ymax = n_div_mean + n_div_sd)) + 
  geom_text(aes(y = n_div_mean + n_div_sd, label = paste("n =", n)), nudge_y = 1) + 
  facet_grid(. ~ chains_assumption, labeller = labeller(chains_assumption = chain_assumption_labs)) + 
  shared_theme + 
  labs(x = "Introduction size", y = "Number of Swiss cantons")
```

Arrange plots together
```{r}
library(cowplot)

plots <- cowplot::align_plots(divisions_per_introduction_plot, divisions_by_introduction_size_plot, align = "v", axis = "b")

plot_grid(plots[[1]], plots[[2]],
          nrow = 2, ncol = 1,
          width = double_col_width,
          labels = c("A", "B")
)

ggsave(
        filename = "figures/swiss_chain_geo_dist.png",
        width = double_col_width,
        height = double_col_width,
        units = "cm"
)
```

Get pearson's R for larger introductions sampled in more cantons
```{r}
ggplot(data = divisions_per_introduction, aes(x = size, y = n_divisions)) + 
  geom_point() + 
  facet_grid(. ~ chains_assumption)

many_cor_data <- divisions_per_introduction %>% filter(chains_assumption == "max")
many_pearson_r <- cor(x = many_cor_data$size, y = many_cor_data$n_divisions, method = "pearson")
cor.test(x = many_cor_data$size, y = many_cor_data$n_divisions, method = "pearson")  # get p-value

few_cor_data <- divisions_per_introduction %>% filter(chains_assumption == "min")
few_pearson_r <- cor(x = few_cor_data$size, y = few_cor_data$n_divisions, method = "pearson")
cor.test(x = few_cor_data$size, y = few_cor_data$n_divisions, method = "pearson")  # get p-value

# Write out results
con <- file("manuscript/intro_size_vs_cantons_cor.tex", open = "w")

writeLines(text = paste0("\\newcommand\\manyintropearsonr{", round(many_pearson_r, digits = 2), "}"), con = con)
writeLines(text = paste0("\\newcommand\\fewintropearsonr{", round(few_pearson_r, digits = 2), "}"), con = con)

close(con)
```